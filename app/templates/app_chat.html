<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEONHIRE | Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="/static/js/app.js"></script>
    <style>
      body {
        min-height: 100vh;
        background: linear-gradient(-45deg, #0b0f1f, #111827, #0f172a, #0b0f1f);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }
      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
    </style>
  </head>
  <body class="text-white">
    <div class="min-h-screen px-6 py-8">
      <div class="max-w-5xl mx-auto">
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center gap-3">
            <svg width="32" height="32" viewBox="0 0 100 100" fill="none">
              <path
                d="M20 80V20L80 80V20"
                stroke="#22d3ee"
                stroke-width="10"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <span class="text-lg font-semibold tracking-widest">NEONHIRE</span>
          </div>
          <div class="flex items-center gap-4 text-sm">
            <button data-nav="freelancers" class="text-slate-300" onclick="window.location.href='/app/freelancers'">Freelancers</button>
            <button data-nav="jobs" class="text-slate-300" onclick="window.location.href='/app/jobs'">Jobs</button>
            <button data-nav="chat" class="text-cyan-300" onclick="window.location.href='/app/chat'">Chat</button>
            <button data-lang-toggle class="text-xs uppercase tracking-widest text-cyan-200">EN/RU</button>
          </div>
        </div>
        <div class="grid lg:grid-cols-[320px_1fr] gap-6">
          <div class="bg-white/10 border border-white/10 rounded-xl p-4">
            <h2 class="text-lg font-semibold mb-2" data-i18n="chatTitle">Start chat</h2>
            <form id="connectForm" class="grid gap-3">
              <input
                type="number"
                name="userId"
                placeholder="User ID"
                required
                class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"
              />
              <button type="submit" class="w-full py-2 rounded-lg bg-cyan-400/90 hover:bg-cyan-300 text-slate-900" data-i18n="loadHistory">
                Load history
              </button>
            </form>
          </div>
          <div class="bg-white/10 border border-white/10 rounded-xl p-4 flex flex-col h-[60vh]">
            <div id="chatLog" class="flex-1 overflow-y-auto space-y-3"></div>
            <form id="messageForm" class="mt-4 grid grid-cols-[1fr_auto] gap-3">
              <input
                type="text"
                name="content"
                placeholder="Message"
                class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"
              />
              <button type="submit" class="px-4 py-2 rounded-lg bg-cyan-400/90 hover:bg-cyan-300 text-slate-900" data-i18n="send">
                Send
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      requireAuth();
      setActiveNav("chat");
      const dict = {
        en: {
          chatTitle: "Start chat",
          loadHistory: "Load history",
          send: "Send",
        },
        ru: {
          chatTitle: "Начать чат",
          loadHistory: "Загрузить историю",
          send: "Отправить",
        },
      };
      bindLangToggle(dict);

      const chatLog = document.getElementById("chatLog");
      let socket;
      let activeUserId = null;

      function appendMessage(message, self = false) {
        const bubble = document.createElement("div");
        bubble.className = `max-w-xs px-3 py-2 rounded-lg ${self ? "bg-cyan-400/80 text-slate-900 self-end" : "bg-white/10"}`;
        bubble.textContent = `${message.content}`;
        chatLog.appendChild(bubble);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function connectSocket() {
        const token = getToken();
        if (!token) return;
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        socket = new WebSocket(`${protocol}://${window.location.host}/api/chat/ws?token=${token}`);
        socket.onmessage = (event) => {
          const message = JSON.parse(event.data);
          appendMessage(message, message.sender_id !== activeUserId);
        };
      }

      connectSocket();

      document.getElementById("connectForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.target;
        activeUserId = Number(form.userId.value);
        chatLog.innerHTML = "";
        const history = await fetchJSON(`/api/chat/history/${activeUserId}`);
        history.forEach((message) => {
          appendMessage(message, message.sender_id !== activeUserId);
        });
      });

      document.getElementById("messageForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.target;
        const content = form.content.value.trim();
        if (!content || !socket || !activeUserId) return;
        socket.send(JSON.stringify({ receiver_id: activeUserId, content }));
        form.reset();
      });
    </script>
  </body>
</html>
